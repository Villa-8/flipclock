<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VILLA-8 | Community Chat</title>
    <style>
        :root {
            --bg: #0b141a; /* Dark Blue WhatsApp-like */
            --header: #202c33;
            --bubble-sent: #005c4b;
            --bubble-recv: #202c33;
            --accent: #00a884;
            --text: #e9edef;
        }

        body {
            margin: 0; background: var(--bg); color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica;
            display: flex; flex-direction: column; height: 100vh; overflow: hidden;
        }

        /* --- Header & Side Menu --- */
        header {
            background: var(--header); padding: 10px 15px; display: flex; 
            justify-content: space-between; align-items: center; border-bottom: 1px solid #333;
        }

        .menu-btn { font-size: 24px; cursor: pointer; color: var(--text); }
        
        #sidebar {
            position: fixed; top: 0; left: -250px; width: 250px; height: 100%;
            background: var(--header); transition: 0.3s; z-index: 100; box-shadow: 2px 0 5px rgba(0,0,0,0.5);
            padding: 20px;
        }
        #sidebar.open { left: 0; }
        .sidebar-item { padding: 15px 0; border-bottom: 1px solid #333; cursor: pointer; }

        /* --- Chat Display --- */
        #chat-window {
            flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px;
            background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
            background-blend-mode: overlay;
        }

        .bubble {
            max-width: 85%; padding: 8px 12px; border-radius: 8px; position: relative;
            font-size: 0.95rem; line-height: 1.4; word-wrap: break-word;
        }
        .sent { align-self: flex-end; background: var(--bubble-sent); border-top-right-radius: 0; }
        .received { align-self: flex-start; background: var(--bubble-recv); border-top-left-radius: 0; }
        .sender { font-size: 0.75rem; color: var(--accent); font-weight: bold; display: block; }
        .time { font-size: 0.65rem; color: rgba(255,255,255,0.5); float: right; margin-top: 4px; margin-left: 8px; }

        /* --- Input Bar --- */
        .input-bar {
            background: var(--header); padding: 10px; display: flex; align-items: flex-end; gap: 10px;
        }
        .input-bar textarea {
            flex: 1; background: #2a3942; border: none; color: white; padding: 10px 15px;
            border-radius: 20px; resize: none; max-height: 100px; outline: none;
        }
        .send-btn { background: var(--accent); border: none; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; }

        /* --- Auth Overlay --- */
        #auth-overlay {
            position: fixed; inset: 0; background: var(--bg); z-index: 1000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .auth-card { background: var(--header); padding: 30px; border-radius: 15px; width: 80%; max-width: 350px; text-align: center; }
        .auth-card input { width: 100%; padding: 12px; margin: 10px 0; background: #2a3942; border: 1px solid #444; color: white; border-radius: 5px; }

        /* Responsive Fixes */
        @media (max-width: 600px) { .bubble { max-width: 90%; } }
    </style>
</head>
<body>

<div id="auth-overlay">
    <div class="auth-card">
        <h2 style="color:var(--accent)">VILLA-8 Chat</h2>
        <input type="text" id="reg-name" placeholder="Full Name">
        <input type="text" id="reg-email" placeholder="Email or Mobile No.">
        <button onclick="saveUser()" style="width:100%; padding:12px; background:var(--accent); border:none; border-radius:5px; font-weight:bold;">Join Conversation</button>
    </div>
</div>

<div id="sidebar">
    <h3 style="color:var(--accent)">Settings</h3>
    <div class="sidebar-item" onclick="logout()">Logout</div>
    <div class="sidebar-item" onclick="adminClear()">Admin: Clear Chat</div>
    <div class="sidebar-item" onclick="toggleSidebar()">Close Menu</div>
</div>

<header>
    <div class="menu-btn" onclick="toggleSidebar()">â˜°</div>
    <div style="font-weight:bold; letter-spacing:1px;">VILLA-8</div>
    <div style="width:24px;"></div>
</header>

<div id="chat-window"></div>

<div class="input-bar">
    <textarea id="msg-input" placeholder="Message" rows="1"></textarea>
    <button class="send-btn" onclick="sendMessage()">âž¤</button>
</div>

<script>
    const API = 'https://script.google.com/macros/s/AKfycbwNePV6LXtQEWKP8fYHaPocTI1zp2aq2IhmSFjB28htuerelQB46vi3aHPaVznIs5o2/exec';
    let userData = JSON.parse(localStorage.getItem('v8_user'));

    if(userData) document.getElementById('auth-overlay').style.display = 'none';

    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }

    function saveUser() {
        const n = document.getElementById('reg-name').value;
        const e = document.getElementById('reg-email').value;
        if(n && e) {
            userData = { name: n, email: e };
            localStorage.setItem('v8_user', JSON.stringify(userData));
            document.getElementById('auth-overlay').style.display = 'none';
            sync();
        }
    }

    function logout() {
        localStorage.removeItem('v8_user');
        location.reload();
    }

    async function sync() {
        try {
            const res = await fetch(API);
            const data = await res.json();
            const win = document.getElementById('chat-window');
            win.innerHTML = data.map(m => {
                const isMe = m.email === userData.email;
                const parsedMsg = parseContent(m.msg);
                return `
                    <div class="bubble ${isMe ? 'sent' : 'received'}">
                        <span class="sender">${isMe ? 'You' : m.name}</span>
                        ${parsedMsg}
                        <span class="time">${new Date(m.time).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
                    </div>
                `;
            }).join('');
            win.scrollTop = win.scrollHeight;
        } catch(e) {}
    }

    function parseContent(text) {
        // Detects Image/Video/PDF links and renders them
        const urlPattern = /(https?:\/\/[^\s]+)/g;
        return text.replace(urlPattern, (url) => {
            if (url.match(/\.(jpeg|jpg|gif|png)$/) != null) return `<br><img src="${url}" style="max-width:100%; border-radius:5px; margin-top:5px;">`;
            if (url.match(/\.(mp4|webm)$/) != null) return `<br><video src="${url}" controls style="max-width:100%; border-radius:5px;"></video>`;
            if (url.match(/\.(pdf)$/) != null) return `<br><a href="${url}" target="_blank" style="color:var(--accent)">ðŸ“„ Open PDF Document</a>`;
            return `<a href="${url}" target="_blank" style="color:var(--accent)">${url}</a>`;
        });
    }

    async function sendMessage() {
        const input = document.getElementById('msg-input');
        const msg = input.value.trim();
        if(!msg) return;

        // Admin Edit logic (Example: "ADMIN:PASSWORD:Message")
        let pass = "";
        if(msg.startsWith("/admin ")) {
            pass = prompt("Enter Admin Password:");
        }

        await fetch(API, {
            method: 'POST',
            body: JSON.stringify({ ...userData, message: msg, password: pass })
        });
        input.value = '';
        sync();
    }

    async function adminClear() {
        const p = prompt("Enter Admin Password to Clear All:");
        if(!p) return;
        await fetch(API, { method: 'POST', body: JSON.stringify({ command: "CLEAR_ALL", password: p }) });
        sync();
    }

    if(userData) { sync(); setInterval(sync, 5000); }
</script>

</body>
    </html>
