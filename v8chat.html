<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>VILLA-8 iOS 16</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --ios-blue: #007AFF;
            --ios-glass: rgba(255, 255, 255, 0.1);
            --ios-bg: #000000;
            --ios-card: rgba(28, 28, 30, 0.8);
        }

        body, html { 
            margin: 0; padding: 0; height: 100%; width: 100%;
            background: var(--ios-bg); color: #fff; font-family: -apple-system, sans-serif;
            overflow: hidden;
        }

        /* Blur Background */
        .mesh-bg {
            position: fixed; inset: 0; z-index: -1;
            background: radial-gradient(at 0% 0%, #1c1c1e 0%, transparent 50%),
                        radial-gradient(at 100% 100%, #007AFF 0%, transparent 50%);
            filter: blur(80px);
        }

        .view { display: none; height: 100dvh; flex-direction: column; animation: slideIn 0.3s ease; }
        .view.active { display: flex; }
        @keyframes slideIn { from { transform: translateX(30px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* iOS 16 Glass Header */
        header {
            background: rgba(0,0,0,0.4); backdrop-filter: blur(25px) saturate(180%);
            height: 90px; padding: 40px 20px 10px; display: flex; align-items: center;
            justify-content: space-between; border-bottom: 0.5px solid rgba(255,255,255,0.1);
        }

        /* Glass Bubbles */
        .bubble {
            max-width: 75%; padding: 10px 16px; border-radius: 20px; font-size: 16px;
            margin: 4px 0; position: relative; backdrop-filter: blur(10px);
        }
        .sent { 
            align-self: flex-end; background: var(--ios-blue); 
            border-bottom-right-radius: 4px; box-shadow: 0 4px 15px rgba(0,122,255,0.3);
        }
        .recv { 
            align-self: flex-start; background: rgba(58,58,60,0.8); 
            border-bottom-left-radius: 4px; border: 0.5px solid rgba(255,255,255,0.1);
        }

        /* Context Menu (Delete) */
        .msg-menu {
            position: absolute; background: rgba(44,44,46,0.95); border-radius: 12px;
            padding: 10px; display: none; z-index: 100; min-width: 140px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        /* Action Buttons */
        .btn-ios {
            background: var(--ios-blue); border: none; color: white;
            padding: 12px 25px; border-radius: 12px; font-weight: 600; font-size: 16px;
        }

        .input-area {
            background: rgba(0,0,0,0.6); backdrop-filter: blur(30px);
            padding: 10px 15px 30px; display: flex; align-items: center; gap: 10px;
        }

        .ios-input {
            flex: 1; background: rgba(255,255,255,0.1); border: none;
            padding: 10px 15px; border-radius: 20px; color: white; outline: none;
        }
    </style>
</head>
<body>

<div class="mesh-bg"></div>

<div id="v-login" class="view active" style="justify-content:center; align-items:center;">
    <div style="background:var(--ios-card); padding:40px; border-radius:30px; backdrop-filter:blur(20px); text-align:center; width:85%; max-width:350px;">
        <h1 style="margin:0 0 10px;">Villa-8</h1>
        <p style="opacity:0.6; margin-bottom:30px;">Premium Messaging</p>
        <input type="text" id="reg-u" class="ios-input" placeholder="Username" style="width:100%; margin-bottom:15px;">
        <button onclick="login()" class="btn-ios" style="width:100%;">Sign In</button>
    </div>
</div>

<div id="v-hub" class="view">
    <header>
        <span onclick="logout()" style="color:var(--ios-blue); font-size:17px;">Log Out</span>
        <span style="font-weight:700; font-size:18px;">Chats</span>
        <i data-lucide="plus-circle" onclick="showGroupModal()" style="color:var(--ios-blue)"></i>
    </header>
    <div id="contact-list" style="flex:1; overflow-y:auto; padding:10px;"></div>
</div>

<div id="v-chat" class="view">
    <header>
        <i data-lucide="chevron-left" onclick="showView('v-hub')" style="color:var(--ios-blue)"></i>
        <div id="chat-target" style="font-weight:700;">Name</div>
        <i data-lucide="info" style="color:var(--ios-blue)"></i>
    </header>
    <div id="msg-flow" style="flex:1; overflow-y:auto; padding:15px; display:flex; flex-direction:column;"></div>
    <div class="input-area">
        <i data-lucide="plus" style="color:var(--ios-blue)"></i>
        <input type="text" id="m-inp" class="ios-input" placeholder="iMessage">
        <i data-lucide="arrow-up-circle" onclick="sendMsg()" style="width:32px; height:32px; color:var(--ios-blue)"></i>
    </div>
</div>

<script>
    lucide.createIcons();
    const API = "YOUR_APPS_SCRIPT_URL";
    let me = localStorage.getItem('v8_u');
    let to = null;
    let poll = null;

    function showView(id) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    async function login() {
        const u = document.getElementById('reg-u').value.trim();
        if(!u) return;
        const res = await fetch(API, {method:'POST', body:JSON.stringify({action:'SIGN_UP', username:u, id:Date.now()})});
        const status = await res.text();
        if(status === "EXISTS") return alert("Username Taken");
        localStorage.setItem('v8_u', u);
        me = u;
        loadHub();
    }

    function logout() {
        localStorage.removeItem('v8_u');
        location.reload();
    }

    async function loadHub() {
        showView('v-hub');
        // Logic to fetch contacts and groups...
        document.getElementById('contact-list').innerHTML = `
            <div onclick="openChat('Global Group', 'GROUP')" style="padding:15px; background:var(--ios-card); border-radius:15px; margin-bottom:10px; display:flex; align-items:center; gap:15px;">
                <div style="width:50px; height:50px; background:linear-gradient(45deg, #FF9500, #FF3B30); border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold;">G</div>
                <div><b>Global Group</b><br><small style="opacity:0.5;">Tap to join the conversation</small></div>
            </div>
        `;
    }

    function openChat(name, type) {
        to = name;
        document.getElementById('chat-target').innerText = name;
        showView('v-chat');
        sync();
        poll = setInterval(sync, 3000);
    }

    async function sync() {
        const res = await fetch(`${API}?action=SYNC&me=${me}&to=${to}`);
        const data = await res.json();
        const flow = document.getElementById('msg-flow');
        flow.innerHTML = data.map(m => `
            <div class="bubble ${m[1] === me ? 'sent' : 'recv'}" oncontextmenu="showMsgMenu(event, '${m[0]}')">
                <div style="font-size:11px; opacity:0.5; margin-bottom:2px;">${m[1]}</div>
                ${m[3]}
            </div>
        `).join('');
        flow.scrollTop = flow.scrollHeight;
    }

    async function sendMsg() {
        const inp = document.getElementById('m-inp');
        if(!inp.value.trim()) return;
        await fetch(API, {method:'POST', body:JSON.stringify({action:'SEND', from:me, to:to, text:inp.value, type:'msg'})});
        inp.value = '';
        sync();
    }

    function showMsgMenu(e, id) {
        e.preventDefault();
        if(confirm("Delete for everyone?")) {
            fetch(API, {method:'POST', body:JSON.stringify({action:'DELETE', msgId:id, mode:'EVERYONE'})}).then(() => sync());
        }
    }

    if(me) loadHub();
</script>
</body>
    </html>
